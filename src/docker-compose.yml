version: "3.8"

services:
    # Backend API Service
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: 4dt907-backend
        ports:
            - "8000:8000"
        environment:
            - MLFLOW_TRACKING_URI=http://mlflow:5000
        volumes:
            - ./backend:/app
        depends_on:
            - mlflow
        restart: unless-stopped
        networks:
            - app-network

    # Frontend Service
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
        container_name: 4dt907-frontend
        ports:
            - "3000:3000"
        volumes:
            - ./frontend:/app
            - /app/node_modules
        depends_on:
            - backend
        restart: unless-stopped
        networks:
            - app-network

    # MLflow Tracking Server
    # Updated to v3.5.0 to address security vulnerabilities
    mlflow:
        image: ghcr.io/mlflow/mlflow:v3.5.0
        container_name: 4dt907-mlflow
        ports:
            - "5000:5000"
        volumes:
            - mlflow-data:/mlflow
        command: >
            mlflow server
            --host 0.0.0.0
            --port 5000
            --backend-store-uri sqlite:///mlflow/mlflow.db
            --default-artifact-root /mlflow/artifacts
        restart: unless-stopped
        networks:
            - app-network

volumes:
    mlflow-data:
        driver: local

networks:
    app-network:
        driver: bridge
