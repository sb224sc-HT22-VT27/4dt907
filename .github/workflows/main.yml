name: Main CI/CD

permissions:
    contents: read

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

env:
    DOCKER_BUILDKIT: 1
    COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
    backend-test:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./src/backend
        steps:
            - uses: actions/checkout@v4
            
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"
                  cache-dependency-path: src/backend/requirements.txt
            
            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install flake8 pytest
            
            - name: Lint with flake8
              run: |
                  # Stop the build if there are Python syntax errors or undefined names
                  flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                  # Exit-zero treats all errors as warnings
                  flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
            
            - name: Run Tests
              run: |
                  export PYTHONPATH=$PYTHONPATH:$(pwd)
                  pytest tests/ -v

    frontend-test:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./src/frontend
        steps:
            - uses: actions/checkout@v4
            
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: src/frontend/package-lock.json
            
            - name: Install & Lint
              run: |
                  npm ci
                  npm run lint
              # npm run test

    docker-build:
        needs: [backend-test, frontend-test]
        runs-on: ubuntu-latest
        env:
            BACKEND_PORT: ${{ vars.BACKEND_PORT || '8080' }}
            BACKEND_URL: ${{ vars.BACKEND_URL || 'http://backend:8080' }}
            FRONTEND_PORT: ${{ vars.FRONTEND_PORT || '3030' }}
            MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || '' }}
            MODEL_URI_PROD: ${{ secrets.MODEL_URI_PROD || '' }}
            MODEL_URI_DEV: ${{ secrets.MODEL_URI_DEV || '' }}
            MODEL_URI_BACKUP: ${{ secrets.MODEL_URI_BACKUP || '' }}
        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
              with:
                  driver-opts: image=moby/buildkit:latest

            - name: Docker Compose Build & Test
              run: |
                  docker compose -f src/docker-compose.yml build
                  docker compose -f src/docker-compose.yml up -d

                  echo "Waiting for services to be healthy..."
                  MAX_ATTEMPTS="${FRONTEND_HEALTH_MAX_ATTEMPTS:-30}"
                  SLEEP_SECONDS="${FRONTEND_HEALTH_SLEEP_SECONDS:-5}"
                  
                  for i in $(seq 1 "$MAX_ATTEMPTS"); do
                    BACKEND_STATUS=$(docker inspect --format='{{.State.Health.Status}}' 4dt907-backend 2>/dev/null || echo "starting")
                    FRONTEND_STATUS=$(docker inspect --format='{{.State.Health.Status}}' 4dt907-frontend 2>/dev/null || echo "starting")
                    
                    echo "Attempt $i: Backend=$BACKEND_STATUS, Frontend=$FRONTEND_STATUS"
                    
                    if [ "$BACKEND_STATUS" = "healthy" ] && [ "$FRONTEND_STATUS" = "healthy" ]; then
                      echo "All services are healthy!"
                      break
                    fi
                    
                    if [ $i -eq "$MAX_ATTEMPTS" ]; then
                      echo "Services failed to become healthy"
                      docker compose -f src/docker-compose.yml logs
                      exit 1
                    fi
                    
                    sleep "$SLEEP_SECONDS"
                  done
                  
                  docker ps
                  
                  # Test endpoints
                  curl -f http://localhost:$BACKEND_PORT/docs || exit 1
                  curl -f http://localhost:$FRONTEND_PORT || exit 1

            - name: Cleanup
              if: always()
              run: docker compose -f src/docker-compose.yml down -v
