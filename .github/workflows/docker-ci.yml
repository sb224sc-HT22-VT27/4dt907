name: CI/CD Docker

permissions:
    contents: read

on:
    push:
        branches: ["develop"]
    pull_request:
        branches: ["develop"]

env:
    DOCKER_BUILDKIT: 1
    COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
    test-orchestration:
        runs-on: ubuntu-latest
        env:
            BACKEND_PORT: ${{ secrets.BACKEND_PORT || '8080' }}
            BACKEND_URL: ${{ secrets.BACKEND_URL || 'http://backend:8080' }}
            FRONTEND_PORT: ${{ secrets.FRONTEND_PORT || '3030' }}
            MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || '' }}
            MODEL_URI_PROD: ${{ secrets.MODEL_URI_PROD || '' }}
            MODEL_URI_DEV: ${{ secrets.MODEL_URI_DEV || '' }}
            MODEL_URI_BACKUP: ${{ secrets.MODEL_URI_BACKUP || '' }}
            WEAKLINK_MODEL_URI_PROD: ${{ secrets.WEAKLINK_MODEL_URI_PROD || '' }}
            WEAKLINK_MODEL_URI_DEV: ${{ secrets.WEAKLINK_MODEL_URI_DEV || '' }}
            WEAKLINK_MODEL_URI_BACKUP: ${{ secrets.WEAKLINK_MODEL_URI_BACKUP || '' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
              with:
                  driver-opts: image=moby/buildkit:latest

            - name: Docker Compose Build & Test
              run: |
                  docker compose -f src/docker-compose.yml build
                  docker compose -f src/docker-compose.yml up -d

                  echo "Waiting for services to be healthy..."
                  MAX_ATTEMPTS=30
                  SLEEP_SECONDS=5

                  for i in $(seq 1 $MAX_ATTEMPTS); do
                    # Get health status from docker compose
                    BACKEND_HEALTH=$(docker compose -f src/docker-compose.yml ps --format json backend 2>/dev/null | jq -r '.[0].Health // "starting"')
                    FRONTEND_HEALTH=$(docker compose -f src/docker-compose.yml ps --format json frontend 2>/dev/null | jq -r '.[0].Health // "starting"')

                    echo "Attempt $i/$MAX_ATTEMPTS: Backend=$BACKEND_HEALTH, Frontend=$FRONTEND_HEALTH"

                    if [ "$BACKEND_HEALTH" = "healthy" ] && [ "$FRONTEND_HEALTH" = "healthy" ]; then
                      echo "All services are healthy!"
                      break
                    fi

                    if [ $i -eq $MAX_ATTEMPTS ]; then
                      echo "Services failed to become healthy within timeout"
                      docker compose -f src/docker-compose.yml logs
                      exit 1

                      sleep $SLEEP_SECONDS
                  done

                  docker compose -f src/docker-compose.yml ps

                  # Test
                  curl -f http://localhost:$FRONTEND_PORT || exit 1

            - name: Cleanup
              if: always()
              run: docker compose -f src/docker-compose.yml down -v
