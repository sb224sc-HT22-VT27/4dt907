name: Deploy to Vercel

permissions:
    contents: read
    deployments: write

on:
    push:
        branches: ["main"]
    workflow_dispatch:

env:
    VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
    VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
    deploy:
        runs-on: ubuntu-latest
        environment:
            name: production
            url: ${{ steps.deploy.outputs.url }}
        
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: src/frontend/package-lock.json

            - name: Install Vercel CLI
              run: npm install --global vercel@latest

            - name: Pull Vercel Environment Information
              run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

            - name: Build Project Artifacts
              run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
              env:
                  # Backend Configuration
                  BACKEND_PORT: ${{ secrets.BACKEND_PORT || '8080' }}
                  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
                  
                  # Model URIs - Assignment 2
                  MODEL_URI_PROD: ${{ secrets.MODEL_URI_PROD }}
                  MODEL_URI_DEV: ${{ secrets.MODEL_URI_DEV }}
                  MODEL_URI_BACKUP: ${{ secrets.MODEL_URI_BACKUP }}
                  
                  # Model URIs - Assignment 3 (Weakest Link)
                  WEAKLINK_MODEL_URI_PROD: ${{ secrets.WEAKLINK_MODEL_URI_PROD }}
                  WEAKLINK_MODEL_URI_DEV: ${{ secrets.WEAKLINK_MODEL_URI_DEV }}
                  WEAKLINK_MODEL_URI_BACKUP: ${{ secrets.WEAKLINK_MODEL_URI_BACKUP }}
                  
                  # CORS Configuration (optional)
                  PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}

            - name: Deploy Project Artifacts to Vercel
              id: deploy
              run: |
                  url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
                  echo "url=$url" >> $GITHUB_OUTPUT
                  echo "Deployed to: $url"

            - name: Deployment Summary
              run: |
                  echo "### ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Deployment URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
                  echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
